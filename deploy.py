import os
import json
import sys
from web3 import Web3
from dotenv import load_dotenv, set_key

# --- 1. Load Environment Variables ---
load_dotenv()

RPC_URL = os.getenv("RPC_URL", "http://127.0.0.1:8545")
WALLET_ADDRESS = os.getenv("WALLET_ADDRESS")
PRIVATE_KEY = os.getenv("PRIVATE_KEY")

# --- 2. Contract Metadata ---
# The ABI from your Remix compilation
CONTRACT_ABI = json.loads("""
[
    {
        "inputs": [{"internalType": "string", "name": "_sha256Hash", "type": "string"}, {"internalType": "string", "name": "_ipfsUri", "type": "string"}],
        "name": "anchorFile",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "string", "name": "_sha256Hash", "type": "string"}],
        "name": "verifyIntegrity",
        "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
        "stateMutability": "view",
        "type": "function"
    }
]
""")

# PASTE YOUR FULL BYTECODE STRING HERE (from Remix 'object' field)
# Ensure it starts with 0x or just the hex numbers
CONTRACT_BYTECODE = "6080604052348015600e575f5ffd5b5061090d8061001c5f395ff3fe608060405234801561000f575f5ffd5b5060043610610034575f3560e01c80632e98f78914610038578063edbf397d14610068575b5f5ffd5b610052600480360381019061004d91906103bd565b610084565b60405161005f919061041e565b60405180910390f35b610082600480360381019061007d9190610437565b6100ba565b005b5f5f8260405161009491906104ff565b908152602001604051809103902060020160149054906101000a900460ff169050919050565b5f826040516100c991906104ff565b908152602001604051809103902060020160149054906101000a900460ff1615610128576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161011f9061056f565b60405180910390fd5b60405180608001604052808281526020014281526020013373ffffffffffffffffffffffffffffffffffffffff168152602001600115158152505f8360405161017191906104ff565b90815260200160405180910390205f820151815f0190816101929190610793565b50602082015181600101556040820151816002015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060608201518160020160146101000a81548160ff0219169083151502179055509050503373ffffffffffffffffffffffffffffffffffffffff168260405161022b91906104ff565b60405180910390207f490d88cdf1b56e430ad6c8569bb3662f642ce0e842244525558e315cb04583eb83426040516102649291906108a9565b60405180910390a35050565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6102cf82610289565b810181811067ffffffffffffffff821117156102ee576102ed610299565b5b80604052505050565b5f610300610270565b905061030c82826102c6565b919050565b5f67ffffffffffffffff82111561032b5761032a610299565b5b61033482610289565b9050602081019050919050565b828183375f83830152505050565b5f61036161035c84610311565b6102f7565b90508281526020810184848401111561037d5761037c610285565b5b610388848285610341565b509392505050565b5f82601f8301126103a4576103a3610281565b5b81356103b484826020860161034f565b91505092915050565b5f602082840312156103d2576103d1610279565b5b5f82013567ffffffffffffffff8111156103ef576103ee61027d565b5b6103fb84828501610390565b91505092915050565b5f8115159050919050565b61041881610404565b82525050565b5f6020820190506104315f83018461040f565b92915050565b5f5f6040838503121561044d5761044c610279565b5b5f83013567ffffffffffffffff81111561046a5761046961027d565b5b61047685828601610390565b925050602083013567ffffffffffffffff8111156104975761049661027d565b5b6104a385828601610390565b9150509250929050565b5f81519050919050565b5f81905092915050565b8281835e5f83830152505050565b5f6104d9826104ad565b6104e381856104b7565b93506104f38185602086016104c1565b80840191505092915050565b5f61050a82846104cf565b915081905092915050565b5f82825260208201905092915050565b7f46696c6520616c726561647920616e63686f7265642e000000000000000000005f82015250565b5f610559601683610515565b915061056482610525565b602082019050919050565b5f6020820190508181035f8301526105868161054d565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806105d157607f821691505b6020821081036105e4576105e361058d565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026106467fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261060b565b610650868361060b565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f61069461068f61068a84610668565b610671565b610668565b9050919050565b5f819050919050565b6106ad8361067a565b6106c16106b98261069b565b848454610617565b825550505050565b5f5f905090565b6106d86106c9565b6106e38184846106a4565b505050565b5b81811015610706576106fb5f826106d0565b6001810190506106e9565b5050565b601f82111561074b5761071c816105ea565b610725846105fc565b81016020851015610734578190505b610748610740856105fc565b8301826106e8565b50505b505050565b5f82821c905092915050565b5f61076b5f1984600802610750565b1980831691505092915050565b5f610783838361075c565b9150826002028217905092915050565b61079c826104ad565b67ffffffffffffffff8111156107b5576107b4610299565b5b6107bf82546105ba565b6107ca82828561070a565b5f60209050601f8311600181146107fb575f84156107e9578287015190505b6107f38582610778565b86555061085a565b601f198416610809866105ea565b5f5b828110156108305784890151825560018201915060208501945060208101905061080b565b8683101561084d5784890151610849601f89168261075c565b8355505b6001600288020188555050505b505050505050565b5f61086c826104ad565b6108768185610515565b93506108868185602086016104c1565b61088f81610289565b840191505092915050565b6108a381610668565b82525050565b5f6040820190508181035f8301526108c18185610862565b90506108d0602083018461089a565b939250505056fea2646970667358221220e881fbe50e908ae76af59eb376473c62452764ea457e3522278167dbfd1c0b0e64736f6c634300081f0033" # Replace this with your actual long hex string

# --- 3. Initialize Web3 ---
w3 = Web3(Web3.HTTPProvider(RPC_URL))

def deploy_contract():
    # A. Connection Check
    if not w3.is_connected():
        print(f"❌ Error: Could not connect to Ganache at {RPC_URL}. Is it running?")
        return

    # B. Address Validation
    if not WALLET_ADDRESS or not WALLET_ADDRESS.startswith("0x"):
        print("❌ Error: WALLET_ADDRESS in .env is missing or invalid.")
        return

    # C. Balance Check (The "Insufficient Funds" Fix)
    balance_wei = w3.eth.get_balance(WALLET_ADDRESS)
    balance_eth = w3.from_wei(balance_wei, 'ether')
    
    print(f"Connected to Ganache.")
    print(f"Using Wallet: {WALLET_ADDRESS}")
    print(f"Current Balance: {balance_eth} ETH")

    if balance_eth < 0.1:
        print("❌ Error: Insufficient funds! Please use a fresh Ganache account with 1000 ETH.")
        print("Check your .env file and ensure WALLET_ADDRESS and PRIVATE_KEY match Account (0) in Ganache.")
        return

    # D. Build Contract Object
    DataAnchorContract = w3.eth.contract(abi=CONTRACT_ABI, bytecode=CONTRACT_BYTECODE)

    # E. Prepare Transaction
    print("Preparing deployment transaction...")
    nonce = w3.eth.get_transaction_count(WALLET_ADDRESS)
    
    # We use dynamic gas price to ensure the transaction is accepted
    transaction = DataAnchorContract.constructor().build_transaction({
        'chainId': w3.eth.chain_id,
        'gas': 2000000, 
        'gasPrice': w3.eth.gas_price,
        'nonce': nonce,
    })

    # F. Sign and Send
    try:
        signed_txn = w3.eth.account.sign_transaction(transaction, private_key=PRIVATE_KEY)
        print("Sending deployment transaction...")
        tx_hash = w3.eth.send_raw_transaction(signed_txn.raw_transaction)

        # G. Wait for Confirmation
        print(f"Transaction sent! Hash: {w3.to_hex(tx_hash)}")
        print("Waiting for block confirmation...")
        tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
        
        new_address = tx_receipt.contractAddress
        print(f"✅ SUCCESS! Contract deployed at: {new_address}")

        # H. Auto-update .env
        env_path = os.path.join(os.path.dirname(__file__), '.env')
        set_key(env_path, "CONTRACT_ADDRESS", str(new_address))
        print("Updated .env with the new CONTRACT_ADDRESS.")

    except Exception as e:
        print(f"❌ Deployment failed: {e}")

if __name__ == "__main__":
    deploy_contract()